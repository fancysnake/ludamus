name: CI

# Enable Buildkit and let compose use it to speed up image building
env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

on:
  pull_request:
    branches: ["master", "main"]
    paths-ignore: ["docs/**"]

  push:
    branches: ["master", "main"]
    paths-ignore: ["docs/**"]

concurrency:
  group: ${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: 3.14
      - name: Run image
        uses: abatilo/actions-poetry@v3
      - run: poetry install
      - run: poetry run poe prcheck
      - run: poetry run poe test --cov --cov-report=xml
      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

  playwright:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v5
        with:
          python-version: 3.14

      - name: Create .env file for docker-compose
        run: |
          cat << EOF > .env
          ENV=test
          SECRET_KEY=test-secret-key-for-ci
          ALLOWED_HOSTS=localhost,127.0.0.1
          DB_NAME=ludamus_test
          DB_USER=ludamus_user
          DB_PASSWORD=test_password
          DB_HOST=db
          DB_PORT=5432
          AUTH0_DOMAIN=test.auth0.com
          AUTH0_CLIENT_ID=test_client_id
          AUTH0_CLIENT_SECRET=test_client_secret
          ROOT_DOMAIN=127.0.0.1:8000
          SUPPORT_EMAIL=test@example.com
          DEBUG=false
          USE_POSTGRES=false
          EOF

      - name: Run image
        uses: abatilo/actions-poetry@v3

      - run: poetry install
      - uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install
        working-directory: ./tests/e2e

        # per the docs: "caching browser binaries is not recommended,
        # since the amount of time it takes to restore the cache is
        # comparable to the time it takes to download the binaries"
      - name: Install Playwright Browsers
        run: bun playwright install --with-deps
        working-directory: ./tests/e2e

      - name: Run end-to-end tests
        run: bun playwright test
        working-directory: ./tests/e2e

      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: ./tests/e2e/playwright-report/
          retention-days: 30
