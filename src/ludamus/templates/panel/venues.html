{% extends "panel/base.html" %}
{% load i18n %}
{% load heroicons %}
{% block title %}
    {% translate "Venues" %} - Ludamus Backoffice
{% endblock title %}
{% block page_title %}
    {% translate "Venues" %}
{% endblock page_title %}
{% block page_subtitle %}
    {% if current_event %}
        {{ current_event.name }} · {% translate "Physical Locations" %}
    {% endif %}
{% endblock page_subtitle %}
{% block header_actions %}
    {% if current_event %}
        <a href="{% url 'panel:venues-structure' slug=current_event.slug %}"
           class="px-4 py-2 bg-neutral-100 text-neutral-700 rounded-lg hover:bg-neutral-200 transition flex items-center mr-2">
            {% heroicon_outline "rectangle-group" class="w-4 h-4 mr-2" %}
            {% translate "Structure Overview" %}
        </a>
        <a href="{% url 'panel:venue-create' slug=current_event.slug %}"
           class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition flex items-center">
            {% heroicon_outline "plus" class="w-4 h-4 mr-2" %}
            {% translate "New Venue" %}
        </a>
    {% endif %}
{% endblock header_actions %}
{% block content %}
    {% if current_event %}
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <div class="flex">
                {% heroicon_outline "information-circle" class="w-5 h-5 text-blue-500 mr-3 mt-0.5 flex-shrink-0" %}
                <div class="text-sm text-blue-700">
                    <p class="font-medium">{% translate "What are venues?" %}</p>
                    <p class="mt-1">
                        {% translate "Venues are physical locations like buildings, convention centers, or complexes. Each venue is typically identified by its address. Within venues, you can organize areas (floors, wings) and spaces (individual rooms)." %}
                    </p>
                </div>
            </div>
        </div>
        {% if venues %}
            <div class="bg-white rounded-xl shadow-sm border border-neutral-100">
                <table class="min-w-full divide-y divide-neutral-200">
                    <thead class="bg-neutral-50">
                        <tr>
                            <th scope="col" class="w-10 px-3 py-3"></th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">
                                {% translate "Name" context "place" %}
                            </th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">
                                {% translate "Address" %}
                            </th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">
                                {% translate "Areas" %}
                            </th>
                            <th scope="col"
                                class="px-6 py-3 text-right text-xs font-medium text-neutral-500 uppercase tracking-wider">
                                {% translate "Actions" %}
                            </th>
                        </tr>
                    </thead>
                    <tbody id="venues-list" class="bg-white divide-y divide-neutral-200">
                        {% for venue in venues %}
                            <tr class="venue-row hover:bg-neutral-50 cursor-move"
                                draggable="true"
                                data-venue-id="{{ venue.pk }}">
                                <td class="px-3 py-4 text-neutral-400">{% heroicon_outline "bars-3" class="w-4 h-4" %}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-neutral-900">{{ venue.name }}</td>
                                <td class="px-6 py-4 text-sm text-neutral-500">{{ venue.address|default:"—" }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-neutral-500">{{ venue.areas_count }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <a href="{% url 'panel:venue-detail' slug=current_event.slug venue_slug=venue.slug %}"
                                       class="text-primary hover:text-primary/80 mr-4 inline-flex items-center">
                                        {% heroicon_outline "rectangle-group" class="w-4 h-4 mr-1" %}
                                        {% translate "Areas" %}
                                    </a>
                                    <a href="{% url 'panel:venue-edit' slug=current_event.slug venue_slug=venue.slug %}"
                                       class="text-primary hover:text-primary/80 mr-4 inline-flex items-center">
                                        {% heroicon_outline "pencil-square" class="w-4 h-4 mr-1" %}
                                        {% translate "Edit" %}
                                    </a>
                                    <div class="relative inline-block">
                                        <button type="button"
                                                class="action-dropdown-toggle p-2 rounded-lg bg-neutral-100 hover:bg-neutral-200 text-neutral-600 inline-flex items-center"
                                                aria-haspopup="true">
                                            {% heroicon_outline "ellipsis-horizontal" class="w-4 h-4" %}
                                        </button>
                                        <div class="action-dropdown-menu hidden absolute right-0 mt-2 w-40 bg-white rounded-lg shadow-lg border border-neutral-200 z-10">
                                            <a href="{% url 'panel:venue-duplicate' slug=current_event.slug venue_slug=venue.slug %}"
                                               class="flex items-center px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50 rounded-t-lg">
                                                {% heroicon_outline "document-duplicate" class="w-4 h-4 mr-2" %}
                                                {% translate "Duplicate" %}
                                            </a>
                                            <a href="{% url 'panel:venue-copy' slug=current_event.slug venue_slug=venue.slug %}"
                                               class="flex items-center px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50">
                                                {% heroicon_outline "clipboard-document" class="w-4 h-4 mr-2" %}
                                                {% translate "Copy" %}
                                            </a>
                                            <hr class="my-1">
                                            <form method="post"
                                                  action="{% url 'panel:venue-delete' slug=current_event.slug venue_slug=venue.slug %}"
                                                  onsubmit="return confirm('{% translate "Are you sure you want to delete this venue?" %}');">
                                                {% csrf_token %}
                                                <button type="submit"
                                                        class="flex items-center w-full px-4 py-2 text-sm text-red-600 hover:bg-red-50 rounded-b-lg">
                                                    {% heroicon_outline "trash" class="w-4 h-4 mr-2" %}
                                                    {% translate "Delete" %}
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <script>
                (function() {
                    // Dropdown toggle
                    document.querySelectorAll('.action-dropdown-toggle').forEach(button => {
                        button.addEventListener('click', e => {
                            e.stopPropagation();
                            const menu = button.nextElementSibling;
                            const isOpen = !menu.classList.contains('hidden');
                            document.querySelectorAll('.action-dropdown-menu').forEach(m => m.classList.add('hidden'));
                            if (!isOpen) menu.classList.remove('hidden');
                        });
                    });
                    document.addEventListener('click', () => {
                        document.querySelectorAll('.action-dropdown-menu').forEach(m => m.classList.add('hidden'));
                    });
                })();
                (function() {
                    const list = document.getElementById('venues-list');
                    if (!list) return;

                    let draggedRow = null;
                    const reorderUrl = '{% url "panel:venue-reorder" slug=current_event.slug %}';
                    const csrfToken = '{{ csrf_token }}';

                    function saveOrder() {
                        const rows = list.querySelectorAll('.venue-row');
                        const venueIds = Array.from(rows).map(row => parseInt(row.dataset.venueId));

                        fetch(reorderUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken
                            },
                            body: JSON.stringify({
                                venue_ids: venueIds
                            })
                        });
                    }

                    list.addEventListener('dragstart', e => {
                        const row = e.target.closest('.venue-row');
                        if (row) {
                            draggedRow = row;
                            row.style.opacity = '0.5';
                        }
                    });

                    list.addEventListener('dragend', e => {
                        const row = e.target.closest('.venue-row');
                        if (row) {
                            row.style.opacity = '1';
                            draggedRow = null;
                            saveOrder();
                        }
                    });

                    list.addEventListener('dragover', e => {
                        e.preventDefault();
                        const target = e.target.closest('.venue-row');
                        if (target && target !== draggedRow) {
                            const rect = target.getBoundingClientRect();
                            const midY = rect.top + rect.height / 2;
                            if (e.clientY < midY) {
                                target.parentNode.insertBefore(draggedRow, target);
                            } else {
                                target.parentNode.insertBefore(draggedRow, target.nextSibling);
                            }
                        }
                    });
                })();
            </script>
        {% else %}
            <div class="bg-white rounded-xl shadow-sm border border-neutral-100 p-8 text-center">
                <p class="text-neutral-500">{% translate "No venues yet. Venues will be managed here once available." %}</p>
            </div>
        {% endif %}
    {% else %}
        <div class="bg-white rounded-xl shadow-sm border border-neutral-100 p-8 text-center">
            <p class="text-neutral-500">{% translate "No events available. Create an event to get started." %}</p>
        </div>
    {% endif %}
{% endblock content %}
