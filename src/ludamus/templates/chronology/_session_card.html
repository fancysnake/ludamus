{% load i18n %}
<div class="col-12 col-lg-6 col-xl-4">
    <div class="cinematic-card h-100 session-card{% if not data.session.is_enrollment_available or data.should_show_as_inactive or ended %} text-muted{% endif %}"
         data-title="{{ data.session.title|lower }}"
         data-host="{{ data.session.presenter_name }}"
         data-tags="{% for tag in data.session.tags.all %}{{ tag.name }}{% if not forloop.last %},{% endif %}{% endfor %}"
         data-tag-categories="{% for tag in data.session.tags.all %}{{ tag.category.name|slugify }}:{{ tag.name }}{% if not forloop.last %};{% endif %}{% endfor %}"
         data-status="{% if ended %}ended{% elif data.is_ongoing %}in-progress{% elif not data.session.is_enrollment_available %}unavailable{% elif data.session.is_full %}full{% else %}available{% endif %}"
         data-debug-ended="{{ ended|yesno:'true,false' }}"
         data-debug-is-ongoing="{{ data.is_ongoing|yesno:'true,false' }}"
         data-debug-enrollment-available="{{ data.session.is_enrollment_available|yesno:'true,false' }}"
         data-debug-is-full="{{ data.session.is_full|yesno:'true,false' }}"
         data-user-enrolled="{% if data.user_enrolled %}true{% else %}false{% endif %}"
         data-user-waiting="{% if data.user_waiting %}true{% else %}false{% endif %}"
         data-min-age="{{ data.session.min_age }}"
         style="cursor: pointer"
         data-bs-toggle="modal"
         data-bs-target="#sessionDetailModal{{ data.session.id }}">
         
        <div class="cinematic-card__bg">
             <!-- Placeholder for session image or fallback pattern -->
             <div class="cinematic-card__gradient"></div>
             <div class="cinematic-card__blur"></div>
        </div>

        <div class="cinematic-card__content">
            <div class="cinematic-card__corner-tl"></div>
            <div class="cinematic-card__corner-br"></div>

            <div class="d-flex flex-column h-100">
                <!-- Header: Status & Seats (adapted from Paragon) -->
                <div class="d-flex justify-content-between items-start mb-auto">
                     <div class="d-flex items-center gap-2">
                        {% if data.session.min_age > 0 %}
                            <span class="badge bg-dark border border-secondary text-light"
                                  title="Minimum age: {{ data.session.min_age }} years">
                                {{ data.session.min_age }}+
                            </span>
                        {% endif %}
                     </div>
                     <div>
                         <span class="badge {% if data.session.is_full %}bg-danger bg-opacity-25 text-danger border border-danger{% else %}bg-success bg-opacity-25 text-success border border-success{% endif %}">
                            {{ data.session.enrolled_count }}/{{ data.session.effective_participants_limit }} {% translate "Seats" %}
                         </span>
                         {% if data.session.waiting_count > 0 %}
                            <span class="badge bg-warning bg-opacity-25 text-warning border border-warning ms-1">+{{ data.session.waiting_count }} {% translate "wait" %}</span>
                         {% endif %}
                     </div>
                </div>

                <!-- Title & Host -->
                <div class="mt-4 mb-2">
                    <h3 class="cinematic-card__title mb-1">{{ data.session.title }}</h3>
                    <div class="cinematic-card__meta">
                        {% load bootstrap_icons %}
                        {% bs_icon 'person-circle' %} 
                        <span class="text-uppercase tracking-wider small">{{ data.session.presenter_name|default:data.session.presenter_name }}</span>
                    </div>
                </div>

                <!-- Tags -->
                <div class="mb-3">
                    <div class="d-flex flex-wrap gap-1">
                        {% if data.filterable_tags %}
                            {% for tag in data.filterable_tags|slice:":3" %}
                                <span class="badge bg-dark border border-secondary text-muted fw-normal"
                                      title="{{ tag.name }}">
                                    {{ tag.name }}
                                </span>
                            {% endfor %}
                            {% if data.filterable_tags|length > 3 %}
                                <span class="badge bg-transparent text-muted border-0">+{{ data.filterable_tags|length|add:"-3" }}</span>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
                
                <!-- Action Buttons (at bottom) -->
                <div class="mt-auto pt-3 border-top border-secondary border-opacity-25">
                    {% if not ended and data.session.is_enrollment_available and not data.should_show_as_inactive %}
                        {% if request.user.is_authenticated %}
                            {% if data.user_enrolled or data.user_waiting %}
                                <a href="{% url 'web:chronology:session-enrollment' session_id=data.session.id %}"
                                   class="btn btn-outline-warning btn-sm w-100 text-uppercase fw-bold tracking-wide"
                                   onclick="event.stopPropagation();">
                                    {% bs_icon 'gear' %} {% translate "Manage Enrollment" %}
                                </a>
                            {% else %}
                                {% if request.user.user_type == 'connected' or request.user.user_type == 'active' %}
                                    <a href="{% url 'web:chronology:session-enrollment' session_id=data.session.id %}"
                                       class="btn btn-outline-success btn-sm w-100 text-uppercase fw-bold tracking-wide"
                                       onclick="event.stopPropagation();">
                                        {% bs_icon 'person-plus' %} {% translate "Enroll Now" %}
                                    </a>
                                {% else %}
                                    <button class="btn btn-outline-secondary btn-sm w-100" disabled>
                                        {% translate "Only connected users" %}
                                    </button>
                                {% endif %}
                            {% endif %}
                        {% elif request.session.anonymous_enrollment_active %}
                             {% if data.user_enrolled or data.user_waiting %}
                                <a href="{% url 'web:chronology:session-enrollment-anonymous' session_id=data.session.id %}"
                                   class="btn btn-outline-warning btn-sm w-100 text-uppercase fw-bold tracking-wide"
                                   onclick="event.stopPropagation();">
                                    {% bs_icon 'gear' %} {% translate "Manage" %}
                                </a>
                            {% else %}
                                <a href="{% url 'web:chronology:session-enrollment-anonymous' session_id=data.session.id %}"
                                   class="btn btn-outline-success btn-sm w-100 text-uppercase fw-bold tracking-wide"
                                   onclick="event.stopPropagation();">
                                    {% bs_icon 'person-plus' %} {% translate "Enroll Anonymously" %}
                                </a>
                            {% endif %}
                        {% endif %}
                    {% else %}
                        <div class="text-center text-muted small text-uppercase tracking-wide">
                            {% if ended %}
                                {% translate "Session Ended" %}
                            {% elif data.should_show_as_inactive %}
                                {% translate "In Progress" %}
                            {% else %}
                                {% translate "Not Available" %}
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
