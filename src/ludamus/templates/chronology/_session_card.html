{% load i18n %}
{% load heroicons %}
{% load enrollment_tags %}
<div class="session-card rounded-lg card-shadow overflow-hidden h-full flex flex-col{% if not data.session.is_enrollment_available or data.should_show_as_inactive or ended %} opacity-60{% endif %}"
     data-title="{{ data.session.title|lower }}"
     data-host="{{ data.session.presenter_name }}"
     data-tags="{% for tag in data.session.tags.all %}{{ tag.name }}{% if not forloop.last %},{% endif %}{% endfor %}"
     data-tag-categories="{% for tag in data.session.tags.all %}{{ tag.category.name|slugify }}:{{ tag.name }}{% if not forloop.last %};{% endif %}{% endfor %}"
     data-status="{% if ended %}ended{% elif data.is_ongoing %}in-progress{% elif not data.session.is_enrollment_available %}unavailable{% elif data.session.is_full %}full{% else %}available{% endif %}"
     data-debug-ended="{{ ended|yesno:'true,false' }}"
     data-debug-is-ongoing="{{ data.is_ongoing|yesno:'true,false' }}"
     data-debug-enrollment-available="{{ data.session.is_enrollment_available|yesno:'true,false' }}"
     data-debug-is-full="{{ data.session.is_full|yesno:'true,false' }}"
     data-user-enrolled="{% if data.user_enrolled %}true{% else %}false{% endif %}"
     data-user-waiting="{% if data.user_waiting %}true{% else %}false{% endif %}"
     data-min-age="{{ data.session.min_age }}"
     data-space="{{ data.session.agenda_item.space.slug }}"
     style="background-color: var(--theme-bg-secondary);
            cursor: pointer"
     onclick="openSessionModal({{ data.session.id }})">
    <div class="p-4 flex flex-col flex-grow">
        <!-- Session Title -->
        <h6 class="font-semibold mb-2" style="color: var(--theme-text);">{{ data.session.title }}</h6>
        <!-- Session Metadata -->
        <div class="mb-2 space-y-1">
            <div class="flex items-center text-sm"
                 style="color: var(--theme-text-muted)">
                {% heroicon_mini "user-circle" class="w-4 h-4 mr-1 flex-shrink-0" %}
                <span>{{ data.session.presenter_name|default:data.session.presenter_name }}</span>
            </div>
            <div class="flex items-center text-sm"
                 style="color: var(--theme-text-muted)">
                {% heroicon_mini "map-pin" class="w-4 h-4 mr-1 flex-shrink-0" %}
                {% if data.session.agenda_item.space %}
                    <span>{{ data.session.agenda_item.space.name }}</span>
                {% else %}
                    <span>{% translate "TBA" %}</span>
                {% endif %}
            </div>
        </div>
        <!-- Participants Info -->
        <div class="mb-2 flex flex-wrap items-center gap-1">
            <span class="px-2 py-0.5 text-xs rounded"
                  style="background-color: var(--theme-success);
                         color: var(--theme-text-inverse)">
                {{ data.session.enrolled_count }}/{{ data.session.effective_participants_limit }}
            </span>
            {% if data.session.waiting_count > 0 %}
                <span class="px-2 py-0.5 text-xs rounded"
                      style="background-color: var(--theme-warning);
                             color: var(--theme-text-inverse)">
                    +{{ data.session.waiting_count }} {% translate "waiting" %}
                </span>
            {% endif %}
            {% if data.session.is_full %}
                <span class="text-xs" style="color: var(--theme-danger);">{% enrollment_status_text data.session %}</span>
            {% endif %}
        </div>
        <!-- Tags and Age Restrictions -->
        <div class="mb-3 flex-grow">
            <div class="flex flex-wrap items-start gap-1">
                {% if data.session.min_age > 0 %}
                    <span class="px-2 py-0.5 text-xs rounded inline-flex items-center"
                          style="background-color: var(--theme-bg-tertiary);
                                 color: var(--theme-text-secondary)"
                          title="{% translate "Minimum age:" %} {{ data.session.min_age }} {% translate "years" %}">
                        {% heroicon_mini "shield-check" class="w-3 h-3 mr-1" %}
                        {{ data.session.min_age }}+
                    </span>
                {% else %}
                    <span class="px-2 py-0.5 text-xs rounded inline-flex items-center"
                          style="background-color: var(--theme-bg-tertiary);
                                 color: var(--theme-text-secondary)"
                          title="{% translate "All ages welcome" %}">
                        {% heroicon_mini "shield-check" class="w-3 h-3 mr-1" %}
                        {% translate "All ages" %}
                    </span>
                {% endif %}
                {% if data.filterable_tags %}
                    {% for tag in data.filterable_tags|slice:":2" %}
                        <span class="px-2 py-0.5 text-xs rounded filterable-tag"
                              style="background-color: var(--theme-bg-tertiary);
                                     color: var(--theme-text-secondary)"
                              title="{{ tag.name }}">{{ tag.name }}</span>
                    {% endfor %}
                    {% if data.filterable_tags|length > 2 %}
                        <span class="text-xs" style="color: var(--theme-text-muted);">
                            +{{ data.filterable_tags|length|add:"-2" }} {% translate "more..." %}
                        </span>
                    {% endif %}
                {% endif %}
            </div>
        </div>
        <!-- Action Buttons -->
        <div class="mt-auto">
            <div class="flex flex-col gap-1">
                <!-- Primary enrollment action -->
                {% if not ended and data.session.is_enrollment_available and not data.should_show_as_inactive %}
                    {% if request.user.is_authenticated %}
                        <!-- Authenticated user -->
                        {% if data.user_enrolled or data.user_waiting %}
                            <a href="{% url 'web:chronology:session-enrollment' session_id=data.session.id %}"
                               class="inline-flex items-center justify-center px-3 py-1.5 text-xs font-medium rounded transition"
                               style="background-color: var(--theme-warning);
                                      color: var(--theme-text-inverse)"
                               onclick="event.stopPropagation();">
                                {% heroicon_mini "cog-6-tooth" class="w-4 h-4 mr-1" %}
                                {% translate "Manage Enrollment" %}
                            </a>
                        {% else %}
                            {% if request.user.user_type == 'connected' or request.user.user_type == 'active' %}
                                <a href="{% url 'web:chronology:session-enrollment' session_id=data.session.id %}"
                                   class="inline-flex items-center justify-center px-3 py-1.5 text-xs font-medium rounded transition"
                                   style="background-color: var(--theme-success);
                                          color: var(--theme-text-inverse)"
                                   onclick="event.stopPropagation();">
                                    {% heroicon_mini "user-plus" class="w-4 h-4 mr-1" %}
                                    {% translate "Enroll Now" %}
                                </a>
                            {% else %}
                                <button class="inline-flex items-center justify-center px-3 py-1.5 text-xs font-medium rounded opacity-50 cursor-not-allowed"
                                        style="background-color: var(--theme-bg-tertiary);
                                               color: var(--theme-text-secondary);
                                               border: 1px solid var(--theme-border)"
                                        disabled
                                        title="{% translate "Only connected users can enroll" %}">
                                    {% heroicon_mini "user-plus" class="w-4 h-4 mr-1" %}
                                    {% translate "Enroll" %}
                                </button>
                            {% endif %}
                        {% endif %}
                    {% elif request.session.anonymous_enrollment_active %}
                        <!-- Anonymous enrollment mode is active -->
                        {% if data.user_enrolled or data.user_waiting %}
                            <a href="{% url 'web:chronology:session-enrollment-anonymous' session_id=data.session.id %}"
                               class="inline-flex items-center justify-center px-3 py-1.5 text-xs font-medium rounded transition"
                               style="background-color: var(--theme-warning);
                                      color: var(--theme-text-inverse)"
                               onclick="event.stopPropagation();">
                                {% heroicon_mini "cog-6-tooth" class="w-4 h-4 mr-1" %}
                                {% translate "Manage Enrollment" %}
                            </a>
                        {% else %}
                            <a href="{% url 'web:chronology:session-enrollment-anonymous' session_id=data.session.id %}"
                               class="inline-flex items-center justify-center px-3 py-1.5 text-xs font-medium rounded transition"
                               style="background-color: var(--theme-success);
                                      color: var(--theme-text-inverse)"
                               onclick="event.stopPropagation();">
                                {% heroicon_mini "user-plus" class="w-4 h-4 mr-1" %}
                                {% translate "Enroll Anonymously" %}
                            </a>
                        {% endif %}
                    {% else %}
                        <!-- Not authenticated and no anonymous mode -->
                        <a href="{% url 'web:crowd:login-required' %}?next={% url 'web:chronology:event' slug=event.slug %}"
                           class="inline-flex items-center justify-center px-3 py-1.5 text-xs font-medium rounded transition"
                           style="background-color: var(--theme-primary);
                                  color: var(--theme-text-inverse)"
                           onclick="event.stopPropagation();">
                            {% heroicon_mini "arrow-right-on-rectangle" class="w-4 h-4 mr-1" %}
                            {% translate "Login to Enroll" %}
                        </a>
                    {% endif %}
                {% else %}
                    <button class="inline-flex items-center justify-center px-3 py-1.5 text-xs font-medium rounded opacity-50 cursor-not-allowed"
                            style="background-color: var(--theme-bg-tertiary);
                                   color: var(--theme-text-secondary);
                                   border: 1px solid var(--theme-border)"
                            disabled>
                        {% if ended %}
                            {% heroicon_mini "check-circle" class="w-4 h-4 mr-1" %}
                            {% translate "Session Ended" %}
                        {% elif data.should_show_as_inactive %}
                            {% heroicon_mini "clock" class="w-4 h-4 mr-1" %}
                            {% translate "In Progress" %}
                        {% else %}
                            {% heroicon_mini "lock-closed" class="w-4 h-4 mr-1" %}
                            {% translate "Not Available" %}
                        {% endif %}
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>
