{% load i18n %}
{% load heroicons %}
<div class="session-card-wrapper">
    <div class="session-card card rounded-2xl h-full{% if not data.is_enrollment_available or data.should_show_as_inactive or ended %} opacity-60{% endif %}{% if data.user_enrolled %} ring-2 ring-coral-400{% endif %}"
         data-title="{{ data.session.title|lower }}"
         data-host="{{ data.session.presenter_name }}"
         data-tags="{% for tag in data.tags %}{{ tag.name }}{% if not forloop.last %},{% endif %}{% endfor %}"
         data-tag-categories="{% for tag in data.tags %}{{ tag.category.name|slugify }}:{{ tag.name }}{% if not forloop.last %};{% endif %}{% endfor %}"
         data-status="{% if ended %}ended{% elif data.is_ongoing %}in-progress{% elif not data.is_enrollment_available %}unavailable{% elif data.is_full %}full{% else %}available{% endif %}"
         data-debug-ended="{{ ended|yesno:'true,false' }}"
         data-debug-is-ongoing="{{ data.is_ongoing|yesno:'true,false' }}"
         data-debug-enrollment-available="{{ data.is_enrollment_available|yesno:'true,false' }}"
         data-debug-is-full="{{ data.is_full|yesno:'true,false' }}"
         data-user-enrolled="{% if data.user_enrolled %}true{% else %}false{% endif %}"
         data-user-waiting="{% if data.user_waiting %}true{% else %}false{% endif %}"
         data-min-age="{{ data.session.min_age }}"
         data-venue="{% if data.loc.area %}{{ data.loc.venue.slug }}{% endif %}"
         style="cursor: pointer"
         onclick="openModal('sessionDetailModal{{ data.session.pk }}')">
        <div class="p-4 flex flex-col h-full">
            <!-- Status badge row -->
            <div class="flex items-start justify-between mb-3">
                {% if data.user_enrolled %}
                    <span class="px-2.5 py-1 rounded-lg text-xs font-semibold bg-coral-500 text-white">
                        {% translate "You're in!" %}
                    </span>
                {% elif data.user_waiting %}
                    <span class="px-2.5 py-1 rounded-lg text-xs font-semibold" style="background-color: var(--theme-warning); color: white">
                        {% translate "Waiting" %}
                    </span>
                {% elif data.is_full %}
                    <span class="px-2.5 py-1 rounded-lg text-xs font-semibold bg-warm-500 text-white">
                        {% translate "Full" %}
                    </span>
                {% elif data.is_enrollment_available and not ended %}
                    <span class="px-2.5 py-1 rounded-lg text-xs font-semibold bg-teal-500 text-white">
                        {% translate "Open" %}
                    </span>
                {% endif %}
            </div>

            <!-- Session Title -->
            <h3 class="font-semibold text-base mb-2" style="color: var(--theme-text)">{{ data.session.title }}</h3>

            <!-- Session Metadata -->
            <div class="mb-3 space-y-1 text-sm" style="color: var(--theme-text-muted)">
                <div class="flex items-center gap-1.5">
                    {% heroicon_mini "user" class="w-4 h-4 shrink-0" %}
                    <span>{{ data.session.presenter_name|default:data.session.presenter_name }}</span>
                </div>
                <div class="flex items-center gap-1.5 venue-icon">
                    {% heroicon_mini "map-pin" class="w-4 h-4 shrink-0" %}
                    {% if data.loc.space %}
                        <span>
                            {% if data.loc.area %}
                                {{ data.loc.venue.name }} ›
                                {{ data.loc.area.name }} ›
                            {% endif %}
                            {{ data.loc.space.name }}
                        </span>
                    {% else %}
                        <span>{% translate "TBA" %}</span>
                    {% endif %}
                </div>
            </div>

            <!-- Tags and Age -->
            <div class="flex flex-wrap gap-1.5 mb-3 grow">
                {% if data.session.min_age > 0 %}
                    <span class="tag-pill px-2 py-0.5 rounded-lg text-xs font-medium bg-warm-200 dark:bg-neutral-700"
                          style="color: var(--theme-text-secondary)"
                          title="{% translate 'Minimum age' %}: {{ data.session.min_age }} {% translate 'years' %}">
                        {{ data.session.min_age }}+
                    </span>
                {% else %}
                    <span class="tag-pill px-2 py-0.5 rounded-lg text-xs font-medium bg-warm-200 dark:bg-neutral-700"
                          style="color: var(--theme-text-secondary)"
                          title="{% translate 'All ages welcome' %}">
                        {% translate "All ages" %}
                    </span>
                {% endif %}
                {% if data.filterable_tags %}
                    {% for tag in data.filterable_tags|slice:":2" %}
                        <span class="tag-pill px-2 py-0.5 rounded-lg text-xs font-medium filterable-tag bg-warm-200 dark:bg-neutral-700"
                              style="color: var(--theme-text-secondary)"
                              title="{{ tag.name }}">
                            {{ tag.name }}
                        </span>
                    {% endfor %}
                    {% if data.filterable_tags|length > 2 %}
                        <span class="text-xs" style="color: var(--theme-text-muted)">
                            +{{ data.filterable_tags|length|add:"-2" }}
                        </span>
                    {% endif %}
                {% endif %}
            </div>

            <!-- Participants + Action -->
            <div class="mt-auto flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-semibold {% if data.is_full %}bg-coral-100 text-coral-700{% else %}bg-teal-100 text-teal-700{% endif %}">
                        {{ data.enrolled_count }}/{{ data.effective_participants_limit }}
                    </span>
                    {% if data.session.waiting_count > 0 %}
                        <span class="text-xs font-medium" style="color: var(--theme-warning)">+{{ data.session.waiting_count }} {% translate "waiting" %}</span>
                    {% endif %}
                </div>

                <!-- Enrollment action -->
                {% if not ended and data.is_enrollment_available and not data.should_show_as_inactive %}
                    {% if request.user.is_authenticated %}
                        {% if data.user_enrolled or data.user_waiting %}
                            <a href="{% url 'web:chronology:session-enrollment' session_id=data.session.pk %}"
                               class="btn text-xs py-1.5 px-3" style="background-color: var(--theme-warning); color: white"
                               onclick="event.stopPropagation();">
                                {% heroicon_mini "cog-6-tooth" class="w-3.5 h-3.5" %} {% translate "Manage" %}
                            </a>
                        {% else %}
                            {% if request.user.user_type == 'connected' or request.user.user_type == 'active' %}
                                <a href="{% url 'web:chronology:session-enrollment' session_id=data.session.pk %}"
                                   class="btn btn-teal text-xs py-1.5 px-3"
                                   onclick="event.stopPropagation();">
                                    {% heroicon_mini "user-plus" class="w-3.5 h-3.5" %} {% translate "Enroll" %}
                                </a>
                            {% else %}
                                <button class="btn btn-secondary text-xs py-1.5 px-3" disabled
                                        title="{% translate 'Only connected users can enroll' %}">
                                    {% heroicon_mini "user-plus" class="w-3.5 h-3.5" %} {% translate "Enroll" %}
                                </button>
                            {% endif %}
                        {% endif %}
                    {% elif request.session.anonymous_enrollment_active %}
                        {% if data.user_enrolled or data.user_waiting %}
                            <a href="{% url 'web:chronology:session-enrollment-anonymous' session_id=data.session.pk %}"
                               class="btn text-xs py-1.5 px-3" style="background-color: var(--theme-warning); color: white"
                               onclick="event.stopPropagation();">
                                {% heroicon_mini "cog-6-tooth" class="w-3.5 h-3.5" %} {% translate "Manage" %}
                            </a>
                        {% else %}
                            <a href="{% url 'web:chronology:session-enrollment-anonymous' session_id=data.session.pk %}"
                               class="btn btn-teal text-xs py-1.5 px-3"
                               onclick="event.stopPropagation();">
                                {% heroicon_mini "user-plus" class="w-3.5 h-3.5" %} {% translate "Enroll" %}
                            </a>
                        {% endif %}
                    {% else %}
                        <a href="{% url 'web:crowd:login-required' %}?next={% url 'web:chronology:event' slug=event.slug %}"
                           class="btn btn-primary text-xs py-1.5 px-3"
                           onclick="event.stopPropagation();">
                            {% heroicon_mini "arrow-right-on-rectangle" class="w-3.5 h-3.5" %} {% translate "Login" %}
                        </a>
                    {% endif %}
                {% else %}
                    <span class="text-xs font-medium" style="color: var(--theme-text-muted)">
                        {% if ended %}
                            {% translate "Ended" %}
                        {% elif data.should_show_as_inactive %}
                            {% translate "In Progress" %}
                        {% else %}
                            {% translate "Not Available" %}
                        {% endif %}
                    </span>
                {% endif %}
            </div>
        </div>
    </div>
</div>
