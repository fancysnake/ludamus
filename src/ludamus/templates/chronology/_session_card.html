<div class="col-12 col-lg-6 col-xl-4">
    <div class="card h-100 session-card{% if not data.session.is_enrollment_available or data.should_show_as_inactive or ended %} text-muted{% endif %}"
         data-title="{{ data.session.title|lower }}"
         data-host="{{ data.session.presenter_name }}"
         data-tags="{% for tag in data.session.tags.all %}{{ tag.name }}{% if not forloop.last %},{% endif %}{% endfor %}"
         data-tag-categories="{% for tag in data.session.tags.all %}{{ tag.category.name|slugify }}:{{ tag.name }}{% if not forloop.last %};{% endif %}{% endfor %}"
         data-status="{% if ended %}ended{% elif data.is_ongoing %}in-progress{% elif not data.session.is_enrollment_available %}unavailable{% elif data.session.is_full %}full{% else %}available{% endif %}"
         data-debug-ended="{{ ended|yesno:'true,false' }}"
         data-debug-is-ongoing="{{ data.is_ongoing|yesno:'true,false' }}"
         data-debug-enrollment-available="{{ data.session.is_enrollment_available|yesno:'true,false' }}"
         data-debug-is-full="{{ data.session.is_full|yesno:'true,false' }}"
         data-user-enrolled="{% if data.user_enrolled %}true{% else %}false{% endif %}"
         data-user-waiting="{% if data.user_waiting %}true{% else %}false{% endif %}"
         data-min-age="{{ data.session.min_age }}">
        <div class="card-body d-flex flex-column">
            <!-- Session Title -->
            <h6 class="card-title mb-2">{{ data.session.title }}</h6>
            <!-- Session Metadata -->
            <div class="mb-2">
                <small class="text-muted d-block mb-1">
                    {% load bootstrap_icons %}
                    {% bs_icon 'person-circle' %} {{ data.session.presenter_name|default:data.session.presenter_name }}
                </small>
                <small class="text-muted d-block mb-1">
                    {% if data.session.agenda_item.space %}
                        {% bs_icon 'geo-alt' %} {{ data.session.agenda_item.space.name }}
                    {% else %}
                        {% load i18n %}
                        {% bs_icon 'geo-alt' %} {% translate "TBA" %}
                    {% endif %}
                </small>
            </div>
            <!-- Participants Info -->
            <div class="mb-2">
                <button type="button"
                        class="btn btn-sm btn-outline-primary border-0 text-start p-0"
                        data-bs-toggle="modal"
                        data-bs-target="#participantsModal{{ data.session.id }}">
                    <span class="badge bg-success">{{ data.session.enrolled_count }}/{{ data.session.effective_participants_limit }}</span>
                    {% if data.session.waiting_count > 0 %}
                        <span class="badge bg-warning text-dark ms-1">+{{ data.session.waiting_count }} waiting</span>
                    {% endif %}
                </button>
                {% if data.session.is_full %}
                    <br>
                    {% load enrollment_tags %}
                    <small class="text-danger">{% enrollment_status_text data.session %}</small>
                {% endif %}
            </div>
            <!-- Tags and Age Restrictions -->
            <div class="mb-3 flex-grow-1">
                <div class="d-flex flex-wrap align-items-start">
                    {% if data.session.min_age > 0 %}
                        <span class="badge bg-light text-dark me-1 mb-1"
                              title="Minimum age: {{ data.session.min_age }} years">
                            {% bs_icon 'shield-check' %}
                            {{ data.session.min_age }}+
                        </span>
                    {% else %}
                        <span class="badge bg-light text-dark me-1 mb-1" title="All ages welcome">
                            {% bs_icon 'shield-check' %}
                            {% translate "All ages" %}
                        </span>
                    {% endif %}
                    {% if data.filterable_tags %}
                        {% for tag in data.filterable_tags|slice:":2" %}
                            <span class="badge bg-light text-dark me-1 mb-1 filterable-tag"
                                  title="{{ tag.name }}">
                                {% if tag.category.icon %}
                                    {% bs_icon tag.category.icon %}
                                {% endif %}
                                {{ tag.name }}
                            </span>
                        {% endfor %}
                        {% if data.filterable_tags|length > 2 %}
                            <small class="text-muted">
                                <a href="#"
                                   data-bs-toggle="modal"
                                   data-bs-target="#sessionDetailModal{{ data.session.id }}"
                                   class="text-decoration-none">+{{ data.filterable_tags|length|add:"-2" }} more...</a>
                            </small>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
            <!-- Action Buttons -->
            <div class="mt-auto">
                <div class="d-flex gap-1 flex-column">
                    <!-- Primary enrollment action -->
                    {% if not ended and data.session.is_enrollment_available and not data.should_show_as_inactive %}
                        {% if request.user.is_authenticated %}
                            <!-- Authenticated user -->
                            {% if data.user_enrolled or data.user_waiting %}
                                <a href="{% url 'web:enroll-select' session_id=data.session.id %}"
                                   class="btn btn-warning btn-sm">
                                    {% bs_icon 'gear' %} {% translate "Manage Enrollment" %}
                                </a>
                            {% else %}
                                {% if request.user.user_type == 'connected' or request.user.user_type == 'active' %}
                                    <a href="{% url 'web:enroll-select' session_id=data.session.id %}"
                                       class="btn btn-success btn-sm">
                                        {% bs_icon 'person-plus' %} {% translate "Enroll Now" %}
                                    </a>
                                {% else %}
                                    <button class="btn btn-outline-secondary btn-sm"
                                            disabled
                                            title="{% translate "Only connected users can enroll" %}">
                                        {% bs_icon 'person-plus' %} {% translate "Enroll" %}
                                    </button>
                                {% endif %}
                            {% endif %}
                        {% elif request.session.anonymous_enrollment_active %}
                            <!-- Anonymous enrollment mode is active -->
                            {% if data.user_enrolled or data.user_waiting %}
                                <a href="{% url 'web:anonymous-enroll' session_id=data.session.id %}"
                                   class="btn btn-warning btn-sm">
                                    {% bs_icon 'gear' %} {% translate "Manage Enrollment" %}
                                </a>
                            {% else %}
                                <a href="{% url 'web:anonymous-enroll' session_id=data.session.id %}"
                                   class="btn btn-success btn-sm">
                                    {% bs_icon 'person-plus' %} {% translate "Enroll Anonymously" %}
                                </a>
                            {% endif %}
                        {% else %}
                            <!-- Not authenticated and no anonymous mode -->
                            <a href="{% url 'web:login' %}?next={% url 'web:event' slug=event.slug %}"
                               class="btn btn-primary btn-sm">
                                {% bs_icon 'box-arrow-in-right' %} {% translate "Login to Enroll" %}
                            </a>
                        {% endif %}
                    {% else %}
                        <button class="btn btn-outline-secondary btn-sm" disabled>
                            {% if ended %}
                                {% bs_icon 'check-circle' %} {% translate "Session Ended" %}
                            {% elif data.should_show_as_inactive %}
                                {% bs_icon 'clock' %} {% translate "In Progress" %}
                            {% else %}
                                {% bs_icon 'lock' %} {% translate "Not Available" %}
                            {% endif %}
                        </button>
                    {% endif %}
                    <!-- View details -->
                    <button type="button"
                            class="btn btn-outline-primary btn-sm"
                            data-bs-toggle="modal"
                            data-bs-target="#sessionDetailModal{{ data.session.id }}">
                        {% bs_icon 'info-circle' %} {% translate "Details" %}
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
