{% extends "base_tailwind.html" %}
{% load i18n %}
{% load heroicons %}
{% load tailwind_forms %}
{% block title %}
    {% translate "Connected users" %}
{% endblock title %}
{% block header_section %}
{% endblock header_section %}
{% block body %}
    <div class="max-w-3xl mx-auto">
        <div class="rounded-lg card-shadow card-accent overflow-hidden"
             style="background-color: var(--theme-bg-secondary)">
            <!-- Tab Navigation -->
            <div class="border-b" style="border-color: var(--theme-border);">
                <nav class="flex -mb-px">
                    <a href="{% url 'web:crowd:profile' %}"
                       class="flex items-center px-4 py-3 text-sm font-medium border-b-2 border-transparent transition hover:border-gray-300"
                       style="color: var(--theme-text-muted)">
                        {% heroicon_outline "user" class="w-4 h-4 mr-2" %}
                        {% translate "Personal Information" %}
                    </a>
                    <a href="{% url 'web:crowd:profile-connected-users' %}"
                       class="flex items-center px-4 py-3 text-sm font-medium border-b-2 transition"
                       style="border-color: var(--theme-primary);
                              color: var(--theme-primary)">
                        {% heroicon_outline "users" class="w-4 h-4 mr-2" %}
                        {% translate "Connected users" %}
                    </a>
                </nav>
            </div>
            <!-- Tab Content -->
            <div class="p-6">
                <!-- Info Alert -->
                <div class="flex items-start p-4 rounded mb-4"
                     style="background-color: var(--theme-info-bg);
                            border: 1px solid var(--theme-info-light);
                            color: var(--theme-info-text)">
                    {% heroicon_outline "information-circle" class="w-5 h-5 mr-3 flex-shrink-0" %}
                    <p class="text-sm">
                        {% translate "Connected people are family members or friends that you can enroll in events. They won't have their own login accounts - you'll handle all their event registrations for them" %}
                    </p>
                </div>
                {% if connected_users|length < max_connected_users %}
                    <!-- Add New Connected User Form -->
                    <div class="rounded p-4 mb-6"
                         style="background-color: var(--theme-bg-tertiary)">
                        <h3 class="flex items-center text-sm font-semibold mb-3"
                            style="color: var(--theme-text)">
                            {% heroicon_outline "plus-circle" class="w-4 h-4 mr-2" %}
                            {% translate "Add connected user" %}
                        </h3>
                        <form action="{% url 'web:crowd:profile-connected-users' %}" method="post">
                            {% csrf_token %}
                            {% tw_form form layout="horizontal" %}
                            <div class="mt-4">{% tw_button "OK" %}</div>
                        </form>
                    </div>
                {% else %}
                    <!-- Max Limit Warning -->
                    <div class="flex items-start p-4 rounded mb-6"
                         style="background-color: var(--theme-warning-bg);
                                border: 1px solid var(--theme-warning-light);
                                color: var(--theme-warning-text)">
                        {% heroicon_outline "exclamation-triangle" class="w-5 h-5 mr-3 flex-shrink-0" %}
                        <p class="text-sm">
                            {% blocktranslate %}You have reached the maximum limit of {{ max_connected_users }} connected users.{% endblocktranslate %}
                        </p>
                    </div>
                {% endif %}
                <!-- Connected Users List -->
                <div class="border-t pt-6" style="border-color: var(--theme-border);">
                    <h3 class="flex items-center text-sm font-semibold mb-4"
                        style="color: var(--theme-text)">
                        {% heroicon_outline "rectangle-stack" class="w-4 h-4 mr-2" %}
                        {% translate "Your connected users" %} (<span id="itemCount">{{ connected_users|length }}</span>/{{ max_connected_users }})
                    </h3>
                    <div id="itemsList" class="space-y-3">
                        {% for connected in connected_users %}
                            <div class="rounded border overflow-hidden"
                                 style="background-color: var(--theme-bg);
                                        border-color: var(--theme-border)">
                                <div class="p-4">
                                    <!-- Display Mode -->
                                    <div class="item-display" id="display-{{ forloop.counter }}">
                                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                                            <div>
                                                <h4 class="font-medium" style="color: var(--theme-text);">{{ connected.user.full_name }}</h4>
                                            </div>
                                            <div class="flex gap-2">
                                                <button type="button"
                                                        onclick="toggleEdit({{ forloop.counter }})"
                                                        class="inline-flex items-center px-3 py-1.5 text-xs font-medium rounded transition"
                                                        style="border: 1px solid var(--theme-primary);
                                                               color: var(--theme-primary)">
                                                    {% heroicon_outline "pencil" class="w-3.5 h-3.5 mr-1" %}
                                                    {% translate "Edit" %}
                                                </button>
                                                <form method="post"
                                                      action="{% url 'web:crowd:profile-connected-users-delete' slug=connected.user.slug %}"
                                                      class="inline">
                                                    {% csrf_token %}
                                                    <button type="submit"
                                                            onclick="return confirm('{% translate "Are you sure you want to delete this item?" %}')"
                                                            class="inline-flex items-center px-3 py-1.5 text-xs font-medium rounded transition"
                                                            style="border: 1px solid var(--theme-danger);
                                                                   color: var(--theme-danger)">
                                                        {% heroicon_outline "trash" class="w-3.5 h-3.5 mr-1" %}
                                                        {% translate "Delete" %}
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Edit Mode (hidden by default) -->
                                    <div class="item-edit hidden" id="edit-{{ forloop.counter }}">
                                        <form action="{% url 'web:crowd:profile-connected-users-update' slug=connected.user.slug %}"
                                              method="post">
                                            {% csrf_token %}
                                            {% tw_form connected.form layout="horizontal" %}
                                            <div class="mt-4 flex gap-2">
                                                {% tw_button "OK" %}
                                                <button type="button"
                                                        onclick="toggleEdit({{ forloop.counter }})"
                                                        class="inline-flex items-center px-4 py-2 text-sm font-medium rounded transition"
                                                        style="background-color: var(--theme-bg-tertiary);
                                                               border: 1px solid var(--theme-border);
                                                               color: var(--theme-text)">
                                                    {% heroicon_outline "x-mark" class="w-4 h-4 mr-1" %}
                                                    {% translate "Cancel" %}
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        {% empty %}
                            <div id="emptyState" class="text-center py-8">
                                <span style="color: var(--theme-text-muted);">{% heroicon_outline "users" class="w-12 h-12 mx-auto mb-3" %}</span>
                                <h5 class="font-medium mb-1" style="color: var(--theme-text-muted);">{% translate "No connected users yet" %}</h5>
                                <p class="text-sm" style="color: var(--theme-text-muted);">
                                    {% translate "Add your first item using the form above." %}
                                </p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock body %}
{% block extra_scripts %}
    <script>
        function toggleEdit(index) {
            const display = document.getElementById('display-' + index);
            const edit = document.getElementById('edit-' + index);
            if (display.classList.contains('hidden')) {
                display.classList.remove('hidden');
                edit.classList.add('hidden');
            } else {
                display.classList.add('hidden');
                edit.classList.remove('hidden');
            }
        }
    </script>
{% endblock extra_scripts %}
