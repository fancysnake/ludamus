[settings]
# Sequential execution to avoid race conditions in parallel tests
jobs = 1

[tools]
python = "3.14"
poetry = { version="latest", pyproject="{{ config_root }}/pyproject.toml" }

[env]
# Mise creates and activates this virtualenv automatically
_.python.venv = { path = ".venv", create = true }

# Common environment variables
PYTHONPATH = "src"
DJANGO_SETTINGS_MODULE = "ludamus.config.settings"
DEBUG = "true"
USE_POSTGRES = "false"
SECRET_KEY = "dev-secret-key-12345"
ROOT_DOMAIN = "localhost:8000"
ALLOWED_HOSTS = ".localhost"

[tasks.p]
run = "poetry"

# Code quality tools
[tasks.black]
run = "black src tests"

[tasks.black-check]
run = "black --check src tests"

[tasks.codespell]
run = "codespell src tests/unit tests/integration"

[tasks.deptry]
run = "deptry src tests"

[tasks.djlint]
run = "djlint src --profile=django"

[tasks.djlint-format]
run = "djlint src --reformat --format-css --format-js --profile=django"

[tasks.mypy]
run = "mypy src"

[tasks.pylint]
run = "pylint src tests"

[tasks.ruff]
run = "ruff check src tests"

[tasks.ruff-fix]
run = "ruff check --fix src tests"

# Django commands
[tasks.dj]
run = "django-admin"

# Base test task with test environment
# Child tasks call this via "mise run" to inherit env vars
[tasks._pytest]
description = "Base pytest runner with test env (internal)"
run = "pytest"
env.ROOT_DOMAIN = "testserver"
env.ALLOWED_HOSTS = ".testserver"
env.TESTING = "true"
env.AUTH0_CLIENT_ID = "test_auth0_client_id"
env.AUTH0_CLIENT_SECRET = "test_auth0_client_secret"
env.AUTH0_DOMAIN = "auth0.example.com"

[tasks.unittest]
description = "Run unit tests"
run = "mise run _pytest -- tests/unit --cov=tests.unit --cov=ludamus --fail-on-template-vars"

[tasks.test]
description = "Run all tests"
run = "mise run _pytest -- tests tests/integration tests/unit --fail-on-template-vars"

# Dev server
[tasks.start]
run = "django-admin runserver localhost:8000"

# Tailwind CSS (uses standalone CLI binary)
[tasks.tw-install]
description = "Install Tailwind CSS standalone CLI"
run = """
if [ ! -f bin/tailwindcss ]; then
  mkdir -p bin
  ARCH=$(uname -m)
  OS=$(uname -s)
  if [ "$ARCH" = "arm64" ] || [ "$ARCH" = "aarch64" ]; then
    ARCH="arm64"
  else
    ARCH="x64"
  fi
  if [ "$OS" = "Darwin" ]; then
    OS="macos"
  else
    OS="linux"
  fi
  echo "Downloading Tailwind CSS for ${OS}-${ARCH}..."
  curl -sL "https://github.com/tailwindlabs/tailwindcss/releases/latest/download/tailwindcss-${OS}-${ARCH}" -o bin/tailwindcss
  chmod +x bin/tailwindcss
  echo "Tailwind CSS installed to bin/tailwindcss"
else
  echo "Tailwind CSS already installed"
fi
"""

[tasks.tw]
description = "Tailwind CSS watch mode"
depends = ["tw-install"]
run = "bin/tailwindcss -i src/ludamus/static/css/index.css -o src/ludamus/static/css/output.css --watch"

[tasks.tw-build]
description = "Build Tailwind CSS (minified)"
depends = ["tw-install"]
run = "bin/tailwindcss -i src/ludamus/static/css/index.css -o src/ludamus/static/css/output.css --minify"

[tasks.dev]
description = "Start Django + Tailwind watch mode"
depends = ["tw-install"]
run = "bin/tailwindcss -i src/ludamus/static/css/index.css -o src/ludamus/static/css/output.css --watch & django-admin runserver localhost:8000"

# Composite tasks
[tasks.check]
depends = [
    "black",
    "ruff-fix",
    "codespell",
    "mypy",
    "djlint",
    "djlint-format",
    "pylint",
]

[tasks.prcheck]
depends = ["black-check", "ruff", "codespell", "mypy", "djlint", "pylint"]

[tasks.update]
run = """
pre-commit autoupdate
pip install -U pip
pip install -U poetry
poetry update
deptry .
poetry show -o
"""
